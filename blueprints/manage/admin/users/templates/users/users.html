{% extends "admin/base.html" %}

{% block content %}
    <div class="d-flex justify-content-end">
        <a href="{{ url_for("manage.admin.users.create_user") }}" class="btn btn-primary" role="button" data-toggle="button">Создать
            пользователя</a>
    </div>
    <div class="d-flex justify-content-end">
        <a href="{{ url_for("manage.admin.users.import_users") }}" class="btn btn-primary" role="button" data-toggle="button">Импортировать
            пользователей из xlsx</a>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-sm" id="users_table">
            <thead>
            <tr>
                <th></th>
                <th>ID</th>
                <th>ФИО</th>
                <th>Класс</th>
                <th>Баланс</th>
            </tr>
            </thead>
            {#            <tbody>#}
            {#            {% for user in users %}#}
            {#                <tr>#}
            {#                    <td>{{ user.id }}</td>#}
            {#                    <td>#}
            {#                        <img src="{{ user.avatar_path }}" height="32px" width="32px" class="rounded-circle me-2">#}
            {#                        {{ user.full_name }} ({{ user.login }})#}
            {#                    </td>#}
            {#                    <td>#}
            {#                        {% if user.group.name %}#}
            {#                            {{ user.group.name }}#}
            {#                        {% else %}#}
            {#                            Нет#}
            {#                        {% endif %}#}
            {#                    </td>#}
            {#                    <td>#}
            {#                        {{ user.balance.amount }} <img src="/static/coin.webp"#}
            {#                                                       style="height: 16px;"> {{ config.COIN_UNIT }}#}
            {#                    </td>#}
            {#                </tr>#}
            {#            {% endfor %}#}
            {##}
            {#            </tbody>#}
        </table>

        <script>
            let table = {}

            function format(data) {
                let html = []
                html.push("<a href=\"/manage/admin/users/new_password/?id=" + data.id + "\" class=\"btn btn-primary btn-sm me-1\" role=\"button\" data-toggle=\"button\">Сгенерировать новый пароль</a>")
                html.push("<a href=\"/manage/admin/users/edit/?id=" + data.id + "\" class=\"btn btn-primary btn-sm me-1\" role=\"button\" data-toggle=\"button\">Редактировать пользователя</a>")
                html.push("<a href=\"/manage/admin/users/delete/?id=" + data.id + "\" class=\"btn btn-danger btn-sm me-1\" role=\"button\" data-toggle=\"button\">Удалить пользователя</a>")
                return html
            }

            $(document).ready(function () {
                table = $('#users_table').DataTable({
                    processing: true,
                    serverSide: true,
                    "language": {
                        "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/ru.json"
                    },
                    "ajax": "/manage/admin/users/_data",
                    columns: [
                        {
                            className: 'dt-control',
                            orderable: false,
                            data: null,
                            defaultContent: '',
                        },
                        {
                            data: 'id',
                            orderable: false
                        },
                        {
                            data: 'full_name',
                            orderable: false
                        },
                        {
                            data: 'group_name',
                            orderable: false
                        },
                        {
                            data: 'balance_amount',
                            orderable: false
                        },
                    ]
                });
            });

            $('#users_table').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    // Open this row
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
        </script>
{% endblock %}